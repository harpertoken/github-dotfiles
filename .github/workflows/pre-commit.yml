---
# SPDX-License-Identifier: MIT
#
# Copyright (c) 2025 Niladri Das
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.

name: pre-commit

on:
  pull_request:
  push:
    branches: [main]

jobs:
  pre-commit:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - uses: actions/setup-python@v6
      with:
        python-version: '3.12'
    - uses: dart-lang/setup-dart@v1
    - name: Install dependencies
      uses: ./.github/actions/install-deps
    - name: Install pre-commit
      run: pip install pre-commit
    - name: Install Dart dependencies
      run: dart pub get
    - name: Run Dart analyze
      run: dart analyze
    - name: Run Dart tests
      run: dart test
    - name: Run pre-commit
      run: pre-commit run --all-files --show-diff-on-failure
    - name: Run actionlint
      run: ./actionlint .github/workflows/*.yml
    - name: Run custom lint
      run: ./bin/lint.sh

  docker:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
    - uses: actions/checkout@v6
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: harpertoken
        password: ${{ secrets.DOCKER_HUB_TOKEN }}
    - name: Build and push to Docker Hub
      uses: docker/build-push-action@v6
      with:
        push: true
        tags: harpertoken/dotfiles:latest
    - name: Log in to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build and push to GHCR
      uses: docker/build-push-action@v6
      with:
        push: true
        tags: ghcr.io/${{ github.repository_owner }}/github-dotfiles:latest

  codeql:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
    - uses: actions/checkout@v6
    - uses: github/codeql-action/init@v4
    - uses: github/codeql-action/analyze@v4

  trivy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
    - uses: actions/checkout@v6
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        format: 'sarif'
        output: 'trivy-results.sarif'
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
