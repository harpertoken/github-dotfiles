#!/usr/bin/env bash
# ==========================================================
# Global Git pre-push hook
# Author: Niladri Das
# Purpose: Run pre-commit and yamllint checks (if available),
#          validate commit messages, and verify author info.
# ==========================================================

set -e

remote_name=$1
url=$2

# --- 1. Run pre-commit checks
if ! command -v pre-commit &>/dev/null; then
    echo "‚ùå pre-commit not found. Install with: pip install pre-commit"
    exit 1
fi
echo "üîç Running pre-commit checks..."
pre-commit run --all-files || exit 1

# --- 2. Run yamllint
if ! command -v yamllint &>/dev/null; then
    echo "‚ùå yamllint not found. Install with: pip install yamllint"
    exit 1
fi
echo "üîç Running yamllint..."
yamllint . || exit 1

# --- 3. Validate each ref being pushed
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        continue
    fi

    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        commits=$(git rev-list $local_sha --not --all)
    else
        commits=$(git rev-list $local_sha --not $remote_sha)
    fi

    echo "üîé Checking commits for $local_ref..."
    for commit in $commits; do
        msg=$(git log --format=%B -n 1 $commit)
        first_line=$(echo "$msg" | head -1)
        author_name=$(git log -1 --format='%an' $commit)
        author_email=$(git log -1 --format='%ae' $commit)

        # Validate commit message
        if [ ${#first_line} -gt 40 ]; then
            echo "‚ùå Commit $commit message too long: ${#first_line} chars (max 40)"
            exit 1
        fi
        if echo "$first_line" | grep -q '[A-Z]'; then
            echo "‚ùå Commit $commit message contains uppercase: $first_line"
            exit 1
        fi
        if ! echo "$first_line" | grep -qE '^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\[.+\])?: .+'; then
            echo "‚ùå Commit $commit has invalid message format: $first_line"
            echo "   Please use: type[scope]: description (lowercase, ‚â§40 chars)"
            exit 1
        fi

        # Validate author identity
        if [ "$author_name" != "Niladri Das" ]; then
            echo "‚ùå Commit $commit has incorrect author name: $author_name"
            echo "   Expected: Niladri Das"
            exit 1
        fi
        if [ "$author_email" != "bniladridas@users.noreply.github.com" ]; then
            echo "‚ùå Commit $commit has incorrect author email: $author_email"
            echo "   Expected: bniladridas@users.noreply.github.com"
            exit 1
        fi
    done
done

echo "‚úÖ All checks passed successfully."
